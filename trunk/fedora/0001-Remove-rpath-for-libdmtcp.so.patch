From 4aab0752a4b0fea5d567f86ba79d909fcbcf9d8f Mon Sep 17 00:00:00 2001
From: Kapil Arya <kapil@ccs.neu.edu>
Date: Tue, 7 Jan 2014 00:31:28 -0500
Subject: [PATCH] Remove rpath for libdmtcp.so.

Search path updated for libmtcp.so.
---
 dmtcp/jalib/jfilesystem.cpp | 14 +++++++++++++-
 dmtcp/src/Makefile.am       |  3 +--
 dmtcp/src/Makefile.in       | 10 ++++------
 dmtcp/src/dmtcp_launch.cpp  | 19 +++++++++++++++++++
 4 files changed, 37 insertions(+), 9 deletions(-)

diff --git a/dmtcp/jalib/jfilesystem.cpp b/dmtcp/jalib/jfilesystem.cpp
index 88a314b..2096f86 100644
--- a/dmtcp/jalib/jfilesystem.cpp
+++ b/dmtcp/jalib/jfilesystem.cpp
@@ -229,6 +229,10 @@ jalib::string jalib::Filesystem::FindHelperUtility(const jalib::string& file,
     "/",
     "/../lib64/dmtcp/",
     "/../lib/dmtcp/",
+
+    /* Remove after libmtcp.so is gone */
+    "/../lib64/",
+    "/../lib/",
   };
   // FIXME: remove /.../lib{,64}/dmtcp/ above, & modify Makefile.in:(un)install
 
@@ -243,7 +247,15 @@ jalib::string jalib::Filesystem::FindHelperUtility(const jalib::string& file,
     "/lib64/dmtcp",
     "/usr/local/lib/dmtcp/",
     "/usr/lib/dmtcp/",
-    "/lib/dmtcp/"
+    "/lib/dmtcp/",
+
+    /* Remove after libmtcp.so is gone */
+    "/usr/local/lib64/",
+    "/usr/lib64/",
+    "/lib64/",
+    "/usr/local/lib/",
+    "/usr/lib/",
+    "/lib/"
   };
 
   dmtcp::string suffixFor32Bits = "";
diff --git a/dmtcp/src/Makefile.am b/dmtcp/src/Makefile.am
index 095e63f..bfe8699 100644
--- a/dmtcp/src/Makefile.am
+++ b/dmtcp/src/Makefile.am
@@ -95,8 +95,7 @@ __targetdir__lib_dmtcp_libdmtcp_so_SOURCES = dmtcpworker.cpp threadsync.cpp \
 		      glibcsystem.cpp \
 		      dmtcpplugin.cpp popen.cpp syslogwrappers.cpp
 
-__targetdir__lib_dmtcp_libdmtcp_so_LDFLAGS = -shared -L$(targetdir)/lib \
-		      -Xlinker -rpath -Xlinker '$$ORIGIN/../'
+__targetdir__lib_dmtcp_libdmtcp_so_LDFLAGS = -shared -L$(targetdir)/lib
 
 #dmtcp_nocheckpoint_LDFLAGS = -static
 
diff --git a/dmtcp/src/Makefile.in b/dmtcp/src/Makefile.in
index b7c0c9a..acef343 100644
--- a/dmtcp/src/Makefile.in
+++ b/dmtcp/src/Makefile.in
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.13.4 from Makefile.am.
+# Makefile.in generated by automake 1.14 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994-2013 Free Software Foundation, Inc.
@@ -551,9 +551,7 @@ __targetdir__lib_dmtcp_libdmtcp_so_SOURCES = dmtcpworker.cpp threadsync.cpp \
 		      glibcsystem.cpp \
 		      dmtcpplugin.cpp popen.cpp syslogwrappers.cpp
 
-__targetdir__lib_dmtcp_libdmtcp_so_LDFLAGS = -shared -L$(targetdir)/lib \
-		      -Xlinker -rpath -Xlinker '$$ORIGIN/../'
-
+__targetdir__lib_dmtcp_libdmtcp_so_LDFLAGS = -shared -L$(targetdir)/lib
 
 #dmtcp_nocheckpoint_LDFLAGS = -static
 
@@ -797,14 +795,14 @@ distclean-compile:
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c -o $@ $<
 
 .c.obj:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c `$(CYGPATH_W) '$<'`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
 
 .cpp.o:
 @am__fastdepCXX_TRUE@	$(AM_V_CXX)$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
diff --git a/dmtcp/src/dmtcp_launch.cpp b/dmtcp/src/dmtcp_launch.cpp
index b525bf8..7d930af 100644
--- a/dmtcp/src/dmtcp_launch.cpp
+++ b/dmtcp/src/dmtcp_launch.cpp
@@ -734,4 +734,23 @@ static void setLDPreloadLibs(bool is32bitElf)
 #endif
   JTRACE("getting value of LD_PRELOAD")
     (getenv("LD_PRELOAD")) (preloadLibs) (preloadLibs32);
+
+  /* Remove after libmtcp.so is gone */
+  if (isSSHSlave) {
+    string ldLibPath = "";
+    if (getenv("LD_LIBRARY_PATH") != NULL) {
+      ldLibPath = getenv("LD_LIBRARY_PATH");
+    }
+
+    string libmtcp = jalib::Filesystem::FindHelperUtility("libmtcp.so");
+    libmtcp = jalib::Filesystem::DirName(libmtcp);
+    ldLibPath += libmtcp;
+#if defined(__x86_64__)
+    string libmtcp32 = jalib::Filesystem::FindHelperUtility("libmtcp.so", true);
+    libmtcp32 = jalib::Filesystem::DirName(libmtcp32);
+    ldLibPath += ":" + libmtcp32;
+#endif
+
+    setenv("LD_LIBRARY_PATH", ldLibPath.c_str(), 1);
+  }
 }
-- 
1.8.5.2

