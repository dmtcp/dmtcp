@SET_MAKE@
LN_S=@LN_S@ -f
MKDIR_P=@MKDIR_P@
CC=@CC@
M32=@M32@
PTRACE_SUPPORT=@PTRACE_SUPPORT@
PACKAGE=@PACKAGE_TARNAME@
VERSION=@PACKAGE_VERSION@
prefix=@prefix@
exec_prefix=@exec_prefix@
datarootdir=@datarootdir@
bindir=@bindir@
libdir=@libdir@
includedir=@includedir@
mandir=@mandir@
infodir=@mandir@

ifeq ($(M32),1)
  MTCP_MAKE_FLAGS = M32=1
else
  MTCP_MAKE_FLAGS = CC=$(CC)
endif

ifeq ($(PTRACE_SUPPORT),yes)
  MTCP_MAKE_FLAGS += PTRACE_SUPPORT=1
endif

libdir_dir := ${shell dirname ${libdir}}
bindir_dir := ${shell dirname ${bindir}}
ifeq ($(libdir_dir),$(bindir_dir))
  rel_libdir := ../${shell basename $(libdir)}
else
  rel_libdir := $(DESTDIR)$(libdir)
endif

# Macros TEST and XTERM_E used on command line by check1, check2, ...:
#   make TEST=readline XTERM_E="xterm -e" check-readline

default: mtcp dmtcp
	($(MAKE) bin)

all: default tests

mtcp:
	(cd mtcp && $(MAKE) $(MTCP_MAKE_FLAGS) build readmtcp)

dmtcp:
	(cd dmtcp/src && $(MAKE))

tests: default
	(cd test && $(MAKE) $(MTCP_MAKE_FLAGS))

#prevent mtcp_restart from flying out of control
LIMIT=ulimit -v 1048576

check:  all
	+bash -c "$(LIMIT) && ./test/autotest.py $*"

check-%: all
	+bash -c "$(LIMIT) && ./test/autotest.py '$*'"

check1: icheck-dmtcp1

check2: tests
	${MAKE} XTERM_E="xterm -e" icheck-readline

check3: icheck-shared-memory

icheck-%: tests
	@ echo ""
	@ echo "*** Type:"
	@ echo "***       h<return> for Help (optional)"
	@ echo "***       c<return> to Checkpoint"
	@ echo "***       k<return> to Kill and observe the Restart"
	@ echo "***       c<return> to Checkpoint again"
	@ echo "***       k<return> to Kill and restart again"
	@ echo "***       q<return> to Quit"
	@ echo ""
	@ echo "Press <return> when ready to start."
	@ read -p "> " dummy
	@ ( rm -f ckpt_$*_* && sleep 3 && \
		echo "" && echo "*** Starting Program" && echo "" && \
		${XTERM_E} $$PWD/bin/dmtcp_checkpoint --join test/$* && \
		echo "" && echo "*** Restarting Program from Checkpoint" \
		  "(press q<return> to quit)" && echo "" && \
		until ls ckpt_$*_*.dmtcp > /dev/null 2>&1; do true; done; \
		${XTERM_E} $$PWD/bin/dmtcp_restart --join --quiet ckpt_$*_*.dmtcp; \
		echo "" && echo "*** Again Restarting Program from Checkpoint" \
		  "(press q<return> to quit)" && echo "" && \
		until ls ckpt_$*_*.dmtcp > /dev/null 2>&1; do true; done; \
		${XTERM_E} $$PWD/bin/dmtcp_restart --join --quiet ckpt_$*_*.dmtcp; \
		) &
	@ bin/dmtcp_coordinator

tidy:
	rm -rf dmtcp-autotest-* ckpt_*_files
	rm -f ckpt_* dmtcp_restart_script* dmtcp-shared-memory.* core*

clean: tidy
	-(cd mtcp  && $(MAKE) clean)
	-(cd dmtcp && $(MAKE) clean)
	-(cd test  && $(MAKE) clean)

distclean: clean
	-(cd mtcp  && $(MAKE) distclean)
	-(cd dmtcp && $(MAKE) distclean)  
	rm -f Makefile test/Makefile test/testconfig.py config.log config.status bin/*

svndist:
	if test "`svn info`"; then \
	  dirname=$(PACKAGE)-$(VERSION)+svn`svnversion`; \
	  svn export . $$dirname; \
	  tar czf $$dirname.tar.gz $$dirname; \
	  rm -rf $$dirname 2&>/dev/null; \
	  ls -l $$dirname.tar.gz; \
	else \
	  echo "svn info failed"; \
	fi

dist: distclean dist_exclude.txt
	dir=`pwd`; cd ..; tar czvf dmtcp.tgz \
	    --exclude-from=$$dir/dist_exclude.txt \
	    --exclude $$dir/dist_exclude.txt \
	    --exclude='.*/.svn/*' --exclude='*/.svn' --exclude='*/.deps' \
	    ./`basename $$dir`
	ls -l ../dmtcp.tgz

bin/% : dmtcp/src/%
	(cd bin && $(LN_S) ../$< $*)

bin/% : mtcp/%
	(cd bin && $(LN_S) ../$< $*)

bin: bin/dmtcp_coordinator bin/dmtcp_checkpoint bin/dmtcp_restart bin/dmtcphijack.so bin/libmtcp.so bin/mtcp_restart bin/dmtcp_command bin/dmtcp_nocheckpoint

install: all 
	if test -z "$(prefix)"; then \
	  echo ERROR: prefix must be defined; \
	  exit 1; \
	fi
	(cd dmtcp && make install)
	cp mtcp/libmtcp.so $(DESTDIR)$(libdir)/dmtcp
	cp mtcp/mtcp_restart $(DESTDIR)$(libdir)/dmtcp
	chmod -f 755 $(DESTDIR)$(libdir)/dmtcp/lib*
	$(MKDIR_P) $(DESTDIR)$(bindir)
	(cd $(DESTDIR)$(bindir) && $(LN_S) $(rel_libdir)/dmtcp/dmtcp_coordinator)
	(cd $(DESTDIR)$(bindir) && $(LN_S) $(rel_libdir)/dmtcp/dmtcp_checkpoint)
	(cd $(DESTDIR)$(bindir) && $(LN_S) $(rel_libdir)/dmtcp/dmtcp_nocheckpoint)
	(cd $(DESTDIR)$(bindir) && $(LN_S) $(rel_libdir)/dmtcp/dmtcp_restart)
	(cd $(DESTDIR)$(bindir) && $(LN_S) $(rel_libdir)/dmtcp/dmtcp_command)
	(cd $(DESTDIR)$(libdir) && mv dmtcp/libdmtcpaware.so.1.0.0 .)
	(cd $(DESTDIR)$(libdir) && $(LN_S) libdmtcpaware.so.1.0.0 libdmtcpaware.so.1)
	(cd $(DESTDIR)$(libdir) && $(LN_S) libdmtcpaware.so.1 libdmtcpaware.so)
	$(MKDIR_P) $(DESTDIR)$(libdir)/dmtcp/examples
	cp test/dmtcpaware*.c $(DESTDIR)$(libdir)/dmtcp/examples

uninstall:
	rm -f "$(DESTDIR)$(bindir)/dmtcp_coordinator"
	rm -f "$(DESTDIR)$(bindir)/dmtcp_checkpoint"
	rm -f "$(DESTDIR)$(bindir)/dmtcp_nocheckpoint"
	rm -f "$(DESTDIR)$(bindir)/dmtcp_restart"
	rm -f "$(DESTDIR)$(bindir)/dmtcp_command"
	rm -f "$(DESTDIR)$(libdir)/libdmtcpaware.so*"
	rm -f "$(DESTDIR)$(libdir)/libdmtcpaware.a"
	rm -f "$(DESTDIR)$(includedir)/dmtcpaware.h"
	rm -Rf "$(DESTDIR)$(libdir)/dmtcp"
	#rm -Rf "$(DESTDIR)$(include/dmtcp"
 
.PHONY: all mtcp dmtcp clean distclean bin examples dmtcp_noexamples
