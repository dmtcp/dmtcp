@SET_MAKE@
LN_S=@LN_S@
MKDIR_P=@MKDIR_P@
CC=@CC@
prefix=@prefix@
mandir=@mandir@

# Macros TEST and XTERM_E used on command line by check1, check2, ...:
#   make TEST=readline XTERM_E="xterm -e" check-readline

all: mtcp dmtcp
	($(MAKE) bin)

mtcp:
	(cd mtcp && $(MAKE) CC=$(CC))

dmtcp:
	(cd dmtcp/src && $(MAKE))

tests:
	(cd test && $(MAKE))

check: all
	+./test/autotest.py

check1: tests
	${MAKE} TEST=dmtcp1 check-dmtcp1

check2: tests
	${MAKE} TEST=readline XTERM_E="xterm -e" check-readline

check3: tests
	${MAKE} TEST=shared-memory check-shared-memory

check-${TEST}: tests
	@ echo ""
	@ echo "*** Type:"
	@ echo "***       h<return> for Help (optional)"
	@ echo "***       c<return> to Checkpoint"
	@ echo "***       k<return> to Kill and observe the Restart"
	@ echo "***       q<return> to Quit"
	@ echo ""
	@ echo "Press <return> when ready to start."
	@ read -p "> " dummy
	( rm -f ckpt_${TEST}* && sleep 3 && \
		echo "" && echo "*** Starting Program" && echo "" && \
		${XTERM_E} $$PWD/bin/dmtcp_checkpoint test/${TEST} && \
		echo "" && echo "*** Restarting Program from Checkpoint" \
		  "(press q<return> to quit)" && echo "" && \
		until ls ckpt_${TEST}_*.mtcp > /dev/null 2>&1; do true; done; \
		${XTERM_E} $$PWD/bin/dmtcp_restart ckpt_${TEST}_*.mtcp; \
		echo "" && echo "*** Again Restarting Program from Checkpoint" \
		  "(press q<return> to quit)" && echo "" && \
		until ls ckpt_${TEST}_*.mtcp > /dev/null 2>&1; do true; done; \
		${XTERM_E} $$PWD/bin/dmtcp_restart ckpt_${TEST}_*.mtcp; \
		) &
	@ bin/dmtcp_coordinator

tidy:
	rm -f ckpt_* dmtcp_restart_script.sh dmtcp-shared-memory.*
	rm -rf tmp-autotest-*

clean: tidy
	-(cd mtcp  && $(MAKE) clean)
	-(cd dmtcp && $(MAKE) clean)
	-(cd test  && $(MAKE) clean)

distclean: clean
	-(cd mtcp  && $(MAKE) distclean)
	-(cd dmtcp && $(MAKE) distclean)  
	rm -f Makefile test/Makefile test/testconfig.py config.log config.status bin/*

dist: distclean
	dir=`pwd`; cd ..; tar czvf dmtcp.tgz --exclude='.*/.svn/*' \
	                                   --exclude='*/.svn' ./`basename $$dir`
	ls -l ../dmtcp.tgz

bin/% : dmtcp/src/%
	(cd bin && $(LN_S) ../$< $*)

bin/% : mtcp/%
	(cd bin && $(LN_S) ../$< $*)

bin: bin/dmtcp_coordinator bin/dmtcp_checkpoint bin/dmtcp_restart bin/dmtcphijack.so bin/mtcp.so bin/mtcp_restart bin/dmtcp_command

install: all 
	if test -z "$(prefix)"; then \
		echo ERROR: prefix must be defined; \
		exit 1; \
	fi
	$(MKDIR_P) $(prefix)/lib/dmtcp
	$(MKDIR_P) $(prefix)/bin
	cp bin/* $(prefix)/lib/dmtcp
	(cd $(prefix)/bin && $(LN_S) ../lib/dmtcp/dmtcp_coordinator)
	(cd $(prefix)/bin && $(LN_S) ../lib/dmtcp/dmtcp_checkpoint)
	(cd $(prefix)/bin && $(LN_S) ../lib/dmtcp/dmtcp_restart)
	(cd $(prefix)/bin && $(LN_S) ../lib/dmtcp/dmtcp_command)

uninstall:
	rm -f $(prefix)/bin/dmtcp_coordinator
	rm -f $(prefix)/bin/dmtcp_checkpoint
	rm -f $(prefix)/bin/dmtcp_restart
	rm -f $(prefix)/bin/dmtcp_command
	rm -Rf $(prefix)/lib/dmtcp
 
.PHONY: all mtcp dmtcp clean distclean bin examples dmtcp_noexamples

