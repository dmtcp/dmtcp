@SET_MAKE@
LN_S = @LN_S@
MKDIR_P = @MKDIR_P@
CC = @CC@
PREFIX = @prefix@

all: mtcp dmtcp_noexamples
	($(MAKE) bin)

mtcp:
	(cd mtcp && $(MAKE) CC=$(CC))

dmtcp:
	(cd dmtcp && $(MAKE))

dmtcp_noexamples:
	(cd dmtcp/src && $(MAKE))

examples:
	(cd dmtcp/examples && $(MAKE))

clean:
	(cd mtcp && $(MAKE) clean)
	(cd dmtcp && $(MAKE) clean)

distclean:
	(cd mtcp && $(MAKE) distclean)
	(cd dmtcp && $(MAKE) distclean)  
	rm -f Makefile config.log config.status bin/*

dist: distclean
	dir=`pwd`; cd ..; tar czvf dmtcp.tgz --exclude='.*/.svn/*' \
	                                   --exclude='*/.svn' ./`basename $$dir`
	ls -l ../dmtcp.tgz

bin/% : dmtcp/src/%
	(cd bin && $(LN_S) ../$< $*)

bin/% : mtcp/%
	(cd bin && $(LN_S) ../$< $*)

bin: bin/dmtcp_coordinator bin/dmtcp_checkpoint bin/dmtcp_restart bin/dmtcphijack.so bin/mtcp.so bin/mtcp_restart

install: all 
	if test -z "$(PREFIX)"; then \
		echo ERROR: PREFIX must be defined; \
		exit 1; \
	fi
	$(MKDIR_P) $(PREFIX)/lib/dmtcp
	$(MKDIR_P) $(PREFIX)/bin
	cp bin/* $(PREFIX)/lib/dmtcp
	(cd $(PREFIX)/bin && $(LN_S) ../lib/dmtcp/dmtcp_coordinator)
	(cd $(PREFIX)/bin && $(LN_S) ../lib/dmtcp/dmtcp_checkpoint)
	(cd $(PREFIX)/bin && $(LN_S) ../lib/dmtcp/dmtcp_restart)

uninstall:
	rm -f $(PREFIX)/bin/dmtcp_coordinator
	rm -f $(PREFIX)/bin/dmtcp_checkpoint
	rm -f $(PREFIX)/bin/dmtcp_restart
	rm -Rf $(PREFIX)/lib/dmtcp
 
.PHONY: all mtcp dmtcp clean distclean bin examples dmtcp_noexamples

