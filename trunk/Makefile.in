@SET_MAKE@
LN_S=@LN_S@ -f
MKDIR_P=@MKDIR_P@
CC=@CC@
M32=@M32@
DEBUG=@DEBUG@
FAST_RESTART=@FAST_RESTART@
HBICT_DELTACOMP=@HBICT_DELTACOMP@
INFINIBAND_SUPPORT=@INFINIBAND_SUPPORT@
PTRACE_SUPPORT=@PTRACE_SUPPORT@
RUN_AS_ROOT=@RUN_AS_ROOT@
HAS_JAVA=@HAS_JAVA@
HAS_SSH=@HAS_SSH@
PACKAGE=@PACKAGE_TARNAME@
PACKAGE_TARNAME=@PACKAGE_TARNAME@-@PACKAGE_VERSION@
VERSION=@PACKAGE_VERSION@
CFLAGS = @CFLAGS@
CPPFLAGS = @CPPFLAGS@
LDFLAGS = @LDFLAGS@
prefix=@prefix@
exec_prefix=@exec_prefix@
datarootdir=@datarootdir@
bindir=@bindir@
libdir=@libdir@
docdir=@docdir@
includedir=@includedir@
mandir=@mandir@
infodir=@mandir@
top_builddir = @top_builddir@
top_srcdir = @top_srcdir@
srcdir = @srcdir@
VPATH = @srcdir@
targetdir = $(top_builddir)

ifeq ($(M32),1)
  targetdir = $(top_builddir)/lib/$(PACKAGE)/32
  INSTALL_FLAGS = libdir=$(libdir)/$(PACKAGE)/32/lib \
		  bindir=$(libdir)/$(PACKAGE)/32/bin install-libs
  UNINSTALL_FLAGS = libdir=$(libdir)/$(PACKAGE)/32/lib \
		    bindir=$(libdir)/$(PACKAGE)/32/bin uninstall-libs
else
  INSTALL_FLAGS = install
  UNINSTALL_FLAGS = uninstall
endif

MANPAGES=dmtcp_coordinator.1.gz dmtcp_command.1.gz dmtcp_inspector.1.gz \
	 dmtcp_launch.1.gz dmtcp_checkpoint.1.gz dmtcp_nocheckpoint.1.gz \
	 dmtcp_restart.1.gz mtcp.1.gz mtcp_restart.1.gz

# Macros TEST and XTERM_E used on command line by check1, check2, ...:
#   make TEST=readline XTERM_E="xterm -e" check-readline

default: display-build-env build

mkdirs:
	$(MKDIR_P) $(targetdir)/bin
	$(MKDIR_P) $(targetdir)/lib/dmtcp
ifeq ($(M32),0)
	$(MKDIR_P) $(targetdir)/include
endif

build: mkdirs mtcp dmtcp plugin contrib
ifeq ($(M32),0)
	$(MAKE) include
endif

all: default

display-build-env: display-config display-release
	@- uname -a
	@- echo 'Compiler:  ${CC}'
	@- ${CC} -v 2>&1
	@- ${LD} -v
	@- if test "$(HAS_JAVA)" = "yes" ; then \
	     java -showversion 2>&1 | head -3 ; \
	   fi
	@ ls -l /lib/libc.so.6 /lib[36]*/libc.so.6 /lib/*/libc.so.6 \
	   2> /dev/null || true
	@ ls -ld /var/*/nscd/* 2> /dev/null || true
	@ echo ""

display-release:
	@ lsb_release -dc 2> /dev/null || \
	    grep -i SUSE /etc/SuSE-release 2> /dev/null || \
	    cat /etc/redhat-release 2> /dev/null || true
	@ cat /etc/debian-version 2> /dev/null && echo '  (Debian)' || true
	@ cat /etc/rocks-release 2> /dev/null || true

display-config:
	@- echo DMTCP version:\
	  ${VERSION} \(`grep 'MTCP_VERSION =' mtcp/Makefile`\)
	@- echo Date built: \ \  `date`
	@- if test -r ./config.log ; then \
	    echo -n 'config.log: ' ; \
	    grep '\$$ .*configure ' config.log | sed -e 's^\$$^^'; \
	   fi

mtcp: mkdirs
	cd mtcp && $(MAKE) $(MTCP_MAKE_FLAGS) build readmtcp

dmtcp:
ifeq ($(M32),1)
	cd dmtcp/src && $(MAKE) libs
else
	cd dmtcp/src && $(MAKE)
endif
	#cd $(targetdir)/bin && $(LN_S) dmtcp_launch dmtcp_checkpoint

plugin: dmtcp
	cd plugin && $(MAKE)

contrib: dmtcp
	cd contrib && $(MAKE)

tests: build
	cd test && $(MAKE)

# Prevent mtcp_restart from flying out of control
# (but Java/IcedTea6-1.9.x/RHEL-6.1 uses lots of memory,
#  and modifies most of the zero-mapped pages -- using 16 MB)
# JDK Runtime Environment (Java/IcedTea6 1.12.4 (OpenJDK, Java 1.6.0_27)
#   now needs at least 32 MB  (June, 2013)
LIMIT=ulimit -v 33554432

check: tests
	@+ if python -c 'print "Python exits."' > /dev/null; then \
	   bash -c "$(LIMIT) && $(top_srcdir)/test/autotest.py ${AUTOTEST} $*"; \
	  else echo '*** No python found in your path.'; echo '*** Please add' \
	   ' python to path or build Python 2.x for x >= 3.'; \
	  fi

check-%: tests
	+bash -c "$(LIMIT) && $(top_srcdir)/test/autotest.py ${AUTOTEST} '$*'"

check1: icheck-dmtcp1

check2: tests
	${MAKE} XTERM_E="xterm -e" icheck-readline

check3: icheck-shared-memory

icheck-%: tests
	@ echo ""
	@ echo "*** Type:"
	@ echo "***       h<return> for Help (optional)"
	@ echo "***       c<return> to Checkpoint"
	@ echo "***       k<return> to Kill and observe the Restart"
	@ echo "***       c<return> to Checkpoint again"
	@ echo "***       k<return> to Kill and restart again"
	@ echo "***       q<return> to Quit"
	@ echo ""
	@ echo "Press <return> when ready to start."
	@ read -p "> " dummy
	@ rm -f ckpt_$*_* && sleep 3 && \
	  echo "" && echo "*** Starting Program" && echo "" && \
	  ${XTERM_E} $(targetdir)/bin/dmtcp_launch --join test/$* && \
	  echo "" && echo "*** Restarting Program from Checkpoint" \
	  "(press q<return> to quit)" && echo "" && \
	  until ls ckpt_$*_*.dmtcp > /dev/null 2>&1; do true; done; \
	  ${XTERM_E} $(targetdir)/bin/dmtcp_restart --join --quiet ckpt_$*_*.dmtcp; \
	  echo "" && echo "*** Again Restarting Program from Checkpoint" \
	  "(press q<return> to quit)" && echo "" && \
	  until ls ckpt_$*_*.dmtcp > /dev/null 2>&1; do true; done; \
	  ${XTERM_E} $(targetdir)/bin/dmtcp_restart --join --quiet ckpt_$*_*.dmtcp; \
	  &
	@ $(targetdir)/bin/dmtcp_coordinator

tidy:
	rm -rf dmtcp-autotest-* ckpt_*_files
	rm -f ckpt_*.dmtcp dmtcp_restart_script* \
	  dmtcp-shared-memory.* dmtcp-test-typescript.tmp core*
	rm -rf ckpt_*

clean: tidy
	- cd mtcp  && $(MAKE) clean
	- cd dmtcp/src && $(MAKE) clean
	- cd plugin && $(MAKE) clean
	- cd contrib && $(MAKE) clean
	- cd test  && $(MAKE) clean
	- if test -z "$$DMTCP_TMPDIR"; then \
	   if test -z "$$TMPDIR"; then \
	     DMTCP_TMPDIR=/tmp/dmtcp-$$USER@`/bin/hostname`; \
	   else \
	     DMTCP_TMPDIR=$$TMPDIR/dmtcp-$$USER@`/bin/hostname`; \
	   fi; \
	 fi; \
	 rm -rf $$DMTCP_TMPDIR
	rm -rf $(targetdir)/include $(targetdir)/lib $(targetdir)/bin

distclean: clean
	- cd mtcp  && $(MAKE) distclean
	- cd dmtcp/src && $(MAKE) distclean
	- cd plugin && $(MAKE) distclean
	- cd contrib && $(MAKE) distclean
	- cd test && $(MAKE) distclean
	rm -f Makefile test/Makefile test/testconfig.py \
	  dmtcp/include/config.h config.log config.status config.cache
	rm -rf autom4te.cache dmtcp/autom4te.cache

distsvn:
	if test "${DISTNAME}"; then \
	  dirname=${DISTNAME}; \
	elif test "`svn info`"; then \
	  dirname=$(PACKAGE)-$(VERSION)+svn`svnversion`; \
	else \
	  echo "svn info failed"; exit 1; \
	fi; \
	svn export . $$dirname; \
	tar czf $$dirname.tar.gz $$dirname; \
	rm -rf $$dirname 2&>/dev/null; \
	ls -l $$dirname.tar.gz;

dist_exclude.txt:
	if ! test -r dist_exclude.txt; then touch dist_exclude.txt; fi

dist: distclean dist_exclude.txt
	dir=`pwd`; cd ..; tar czvf dmtcp.tgz \
	    --exclude-from=$$dir/dist_exclude.txt \
	    --exclude $$dir/dist_exclude.txt --exclude-vcs --exclude='*/.deps' \
	    ./`basename $$dir`
	ls -l ../dmtcp.tgz

$(targetdir)/include/% : dmtcp/include/%
	cp $< $@

$(targetdir)/include/% : mtcp/%
	cp $< $@

include: $(targetdir)/include/mtcp.h $(targetdir)/include/dmtcp.h

create-dirs:
	test -e $(DESTDIR)$(bindir) || $(MKDIR_P) $(DESTDIR)$(bindir)
	test -e $(DESTDIR)$(libdir) || $(MKDIR_P) $(DESTDIR)$(libdir)
	test -e $(DESTDIR)$(includedir) || $(MKDIR_P) $(DESTDIR)$(includedir)
ifeq ($(M32),1)
	test -e $(DESTDIR)$(libdir)/$(PACKAGE)/32/bin || \
	  $(MKDIR_P) $(DESTDIR)$(libdir)/$(PACKAGE)/32/bin
	test -e $(DESTDIR)$(libdir)/$(PACKAGE)/32/lib/$(PACKAGE) || \
	  $(MKDIR_P) $(DESTDIR)$(libdir)/$(PACKAGE)/32/lib/$(PACKAGE)
endif

install: all create-dirs
	cd dmtcp/src && make DESTDIR=$(DESTDIR) $(INSTALL_FLAGS)
	cd plugin && make DESTDIR=$(DESTDIR) $(INSTALL_FLAGS)
	cd contrib && make DESTDIR=$(DESTDIR) $(INSTALL_FLAGS)
	cd mtcp && make DESTDIR=$(DESTDIR)  $(INSTALL_FLAGS)
ifeq ($(M32),0)
	test -e $(DESTDIR)$(docdir)/examples || $(MKDIR_P) $(DESTDIR)$(docdir)/examples
	install -D $(top_srcdir)/test/dmtcpaware*.c $(DESTDIR)$(docdir)/examples
	test -e $(DESTDIR)$(mandir)/man1 || $(MKDIR_P) $(DESTDIR)$(mandir)/man1
	install -D $(top_srcdir)/manpages/dmtcp.1 $(DESTDIR)$(mandir)/man1
	(cd $(DESTDIR)$(mandir)/man1; \
	  for file in ${MANPAGES}; do $(LN_S) dmtcp.1 $$file; done)
endif

uninstall:
	cd dmtcp/src && make DESTDIR=$(DESTDIR) $(UNINSTALL_FLAGS)
	cd plugin && make DESTDIR=$(DESTDIR) $(UNINSTALL_FLAGS)
	cd contrib && make DESTDIR=$(DESTDIR) $(UNINSTALL_FLAGS)
	cd mtcp && make DESTDIR=$(DESTDIR) $(UNINSTALL_FLAGS)
ifeq ($(M32),0)
	rm -Rf "$(DESTDIR)$(docdir)"
	cd $(DESTDIR)$(mandir)/man1 && rm -f dmtcp.1 ${MANPAGES}
endif

.PHONY: default all \
	display-build-env display-release display-config build \
	mtcp dmtcp plugin contrib clean distclean
